{% extends "base.html" %}
{% block content %}
  <h4>{{ text.title }}</h4>
  <p><a href="{{ text.url }}" target="_blank">
    {{ text.url[:65] }}{% if text.url|length > 65 %}...{% endif %}
  </a></p>

<div id="readable-container" style="
  height: calc(100vh - 220px);
  width: calc(100% - 310px);
  overflow-y: auto;
  padding-right: 10px;
  white-space: pre-wrap;
  line-height: 1.6;
">
  <div id="readable-content">
    {{ text.content|safe }}
  </div>
</div>

  <!-- Fixed form in bottom-right corner -->
  <div style="
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: #f1f1f1;
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 10px;
    width: 315px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    z-index: 999;
  ">

    <div id="result-message" style="margin-top: 10px; display: none;"></div>
    <form id="item-form">
      {{ form.hidden_tag() }}
      {{ form.list_name.label }}<br>
      {{ form.list_name(size=31, id="list_name", list="available_lists") }}<br><br>

      {{ form.phrase.label }}
      <a id="glosbe-link" style="float: right;" href="https://glosbe.com" target="_blank" class="btn btn-link disabled">Glosbe</a>
      <a id="cambridge-link" style="float: right;" href="https://dictionary.cambridge.org/dictionary/english/" target="_blank" class="btn btn-link disabled">Cambridge</a>
      <br>
      {{ form.phrase(size=31, id="phrase-field", maxlength=phrase_max_len) }}<br>
      <span id="trim-warning" style="display:none; font-size: 0.9em; color: darkorange;"></span><br>

      {{ form.translation.label }}<br>
      {{ form.translation(rows=2, cols=30, id="translation") }}<br><br>

      {{ form.context.label }}<br>
      {{ form.context(rows=1, cols=30, id="context") }}<br><br>

      <button type="submit">Add</button>
    </form>

    <!-- Datalist with existing lists -->
    <datalist id="available_lists">
      {% for lst in text.training_lists %}
        <option value="{{ lst.name }}">
      {% endfor %}
    </datalist>
  </div>

  <!-- Scripts -->
  <script>
    // Automatically fill phrase field with selection
    document.getElementById("readable-content").addEventListener('mouseup', function () {
        const selection = window.getSelection().toString().trim();
        if (selection.length === 0) return;

        const maxLen = parseInt(document.getElementById('phrase-field').getAttribute('maxlength')) || 200;
        const phraseInput = document.getElementById('phrase-field');
        const warningSpan = document.getElementById('trim-warning');

        if (selection.length > maxLen) {
            phraseInput.value = selection.slice(0, maxLen);
            warningSpan.innerText = `⚠️ Phrase was trimmed to ${maxLen} characters.`;
            warningSpan.style.display = 'inline';
        } else {
            phraseInput.value = selection;
            warningSpan.style.display = 'none';
        }
        phraseInput.dispatchEvent(new Event('input'));

    });
  </script>

  <script>
    let messageTimeout = null;

    document.getElementById("item-form").addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        fetch(window.location.pathname, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            const msg = document.getElementById("result-message");
            const alertClass = result.status === "success" ? "alert-success" : "alert-danger";

            msg.innerHTML = `
              <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${result.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            `;
            msg.style.display = "block";

            if (result.status === "success") {
                document.getElementById("phrase-field").value = "";
                document.getElementById("phrase-field").dispatchEvent(new Event('input'));
                document.getElementById("list_name").value = result.list_name;
                document.getElementById("translation").value = "";
                document.getElementById("context").value = "";
            }

            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                msg.innerHTML = "";
                msg.style.display = "none";
            }, 5000);
        })
        .catch(err => {
            console.error("Error submitting form:", err);
        });
    });

    // Hide message when user starts typing
    document.getElementById("phrase-field").addEventListener("input", () => {
        const msg = document.getElementById("result-message");
        msg.innerHTML = "";
        msg.style.display = "none";
        clearTimeout(messageTimeout);
        if (typeof setGlosbeUrl === 'function') {
          setGlosbeUrl();
        }
        if (typeof setCambridgeUrl === 'function') {
          setCambridgeUrl();
        }
    });
  </script>

  <script>
    function onOffPhraseLink(element_id, delay_ms=0){
      const phrase = document.getElementById('phrase-field').value.trim();
      const link = document.getElementById(element_id);

      setTimeout(() => {
         if (phrase) {
            link.classList.remove('disabled');
         } else {
            link.classList.add('disabled');
         }
      }, delay_ms);
    }
 </script>

<!--  Glosbe Link -->
<script src="{{ url_for('static', filename='js/glosbe_link.js') }}"></script>
<!--  Cambridge Link -->
<script src="{{ url_for('static', filename='js/cambridge_link.js') }}"></script>

{% endblock %}
